pipeline:
  agent:
    any:
    stages:
      - stage: Set log level to "FINE" in apiserver
        - steps:
            - sh sed -i 's/INFO/FINEST/g' api-server/src/main/resources/vertx-default-jul-logging.properties

      - stage: Set log level to "FINE" in authenticator
        - steps:
           - sh sed -i 's/INFO/FINEST/g' authenticator//src/main/resources/vertx-default-jul-logging.properties


      - stage: Compile api server source files
        - steps:
           - sh cd api-server && mvn clean package

      - stage: Compile authenticator source files
        - steps:
          - sh cd authenticator && mvn clean package

      - stage: Install jq and behave
        - steps:
          - sh sudo apt-get -y install jq && sudo apt-get install python3-setuptools && sudo python3 -m pip install behave

      - stage: Set vermillion env to "test" in conf file
        - steps:
          - sh sed -i 's/VERMILLION_ENV=prod/VERMILLION_ENV=test/g' setup/vermillion.conf

      - stage: Install Vermillion
        - steps:
          - sh ./setup/install

      - stage: Wait for the middleware to be available
        - steps:
          - sh cd setup && ./wait.sh

      - stage: Load sample data into ES
        - steps:
          - sh cd setup && ./load_sample_data.sh

      - stage: Run tests and generate reports
        - steps:
          - sh cd setup && ./coverage.sh

